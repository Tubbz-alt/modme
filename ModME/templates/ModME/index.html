<!DOCTYPE>
<html>
<head>
    <style type="text/css">
        h1 {
            margin-bottom: 0;
            text-align: center;
            font-size: 100px;
            color: black;
            background-color:#FFA500;
        }
        p {
            font-family: "Arial";
        }
        body {
            background-color: EEEEEE;
        }
        #content {
            background-color: #DDDDDD;
            text-align: center;
            padding: 1em;
        }
    </style>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js" defer></script>
</head>

<body>

<div id="header">
    <h1>ModME</h1>
</div>

<div id="content">
    <form action="{% url 'ModME:begin' %}" method="post">
        {% csrf_token %}
        <select id = "Parameters" name = "parameter_id">
            <option value="%">---------</option>
            {% for entry in parameters_list %}
                <option value="{{ entry.id }}">{{ entry.Name }}</option>
            {% endfor %}
        </select><br>
        <p>Participant id: <input id="participantAlias" type="text" name="participantAlias"/></p>
        <p>Session id: <input id="sessionName" type="text" name="sessionName"/></p>
        <p>Study id: <input id="studyName" type="text" name="studyName"/></p>
        <label>Reuse Session Data: <input id="reuse" type="checkbox"></label>
        <select id="metadata" name="metadata_id"></select>
        <input id="submit" type="submit" value="Begin" style="display:none"/>
    </form>
    <button id="begin" onclick="checkAndSubmit()"> Begin </button>
</div>

<script type="text/javascript" defer>
const ValidationStatus = Object.freeze({'valid': {}, 'invalid': {}});

function warn(message) {
	console.log(message);    
}
function checkAndSubmit() {
    check()
    .then(
        success => document.getElementById("submit").click(),
        failure => warn(failure)
    );
}
function check() {
    var dataPromise = fetchMetadata();
    return dataPromise.then(
        data => (data.length == 0) ? ValidationStatus.valid : Promise.reject('duplicate record detected'),
        failure => failure
    );
}

function stopRKey(evt) {

    var evt = evt ? evt : ((event) ? event :null);
    var node = (evt.target) ? (evt.target) : (evt.srcElement ? (evt.srcElement) : null);
    if ((evt.keyCode == 13) && (node.type=="text")) {return false;}

}
document.onkeypress = stopRKey;

function escape (value) {
    return (value + "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
}

function dateLeftZero (value)
{
    return (value < 10 ? "0" + value : value);
}

function formatDate (value) {
    var date = new Date(value);
    var output = date.getFullYear() + "-" + dateLeftZero(date.getMonth() + 1) + "-" + dateLeftZero(date.getDay());
    var hour = date.getHours();
    var part = "am";

    if (hour > 12)
    {
        hour -= 12;
        part = "pm";
    }
    return output + " " + hour + ":" + dateLeftZero(date.getMinutes()) + part + " " + date.toString().match(/\(([^)]+)\)$/)[1];
}

function fetchReusableSessions() {

    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function() {

        if (xhr.readyState === 4 && xhr.status === 200) {

            metadata.innerHTML = JSON.parse(xhr.responseText).reduce(function(last, entry) {
                return last + "<option value='" + escape(entry.id) + "'>" + escape(entry.session.name + " - " + formatDate(entry.startTime)) + "</option>";
            }, []);
        }
    };
    xhr.open("GET", (location + "") + "get-reusable-sessions?condition=" + encodeURIComponent(Parameters.value));
    xhr.send();
}

function fetchMetadata(filter) {
    var address = location.href.substr(0, location.href.length-(location.search.length+location.hash.length)) + "metadata/json";
    var query = "?session=" + encodeURIComponent(sessionName.value)
        + "&participant=" + encodeURIComponent(participantAlias.value)
        + "&study=" + encodeURIComponent(studyName.value);
    var data = fetch(address + query)
    .then(response => response.json(), failure => failure)
    return data;
}

Parameters.addEventListener("change", function() {

    reuse.disabled = Parameters.value === "%";

    if (reuse.disabled)
    {
        metadata.innerHTML = "";
    }
    else
    {
        fetchReusableSessions();
    }
});

reuse.disabled = Parameters.value === "%";
reuse.checked = false;
reuse.addEventListener("change", function() {

    metadata.disabled = !reuse.checked;
});

if (!reuse.disabled)
{
    fetchReusableSessions();
}

begin.disabled = false;
metadata.disabled = true;
</script>
</body>
</html>